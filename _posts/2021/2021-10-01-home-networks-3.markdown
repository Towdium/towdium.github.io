---
layout: post
title: 家庭网络杂谈（三）—— 硬件
date: '2021-10-01 10:49'
author: Towdium
catalog: true
tags:
  - 网络
---

## 路由器

上一期说好了来聊聊硬件，那我们就先从路由器说起。在我的规划中，PC 这样的核心设备都需要有线接入，这样速度和可靠性都要有保障得多。而无线路由器的用途仅仅是提供手机等无线设备的网络接入。因此，我们对于无线路由器的需求也仅仅是高覆盖与高可用，至于速度，只要够用就行。不过话又说回来，只要我们的信号覆盖足够好，稍微新一点的设备在速度上都不会有问题。

这本来不是什么大事，但是由于我住的桥洞比较大，本来很简单的问题就复杂起来了。众所周知，目前家用 wifi 的方案不过两种：

- 使用单体高性能的设备：配置简单，信号有多好网速就有多块。缺点在于不管多强的设备，穿两堵承重墙之后信号必然明显衰减。所以不管多贵的设备，跨几堵墙之后要做到满带宽上网几乎是没有可能的。

- 使用 AC+AP / mesh 多点接入：配置复杂，这种复杂一方面在于使用的设备要做到互相兼容，基本上需要同品牌同型号；另一方面在于要合理规划设备的覆盖范围，避免冲突和浪费。另外一个很讨厌的点在于接入设备经常会在接入点之间反复横跳，非常影响体验。说完缺点之后，优势也是显而易见的：AP 设备可以随时增减，从而优化网络环境；每个 AP 覆盖的范围有限，可以在范围内轻松跑满带宽。

尽管很多人家用宽带的带宽已经超过了 200M，但是整体上来说只有 PC 在做文件上传下载时能够跑满带宽，单个无线设备的带宽使用 50M 左右也就感受不到区别了。因此，单体路由器的方案虽然做不到无死角满带宽接入，但是对于我家桥洞的环境来说，算上信号衰减可能正好满足需求。由于长期生活在 100 块某牌垃圾路由器的阴影下，我在做网路规划的时候，对于市售路由器单体性能的认识是不足的，所以也就直接跳过了单体设备的方案，转而使用了多台路由器的组网方式。受到篇幅限制，这里我们就不对网上各种具体的组网方式做区分了，一概称为多点接入的组网方式。

市售的多点接入型号有很多，我这里用的是菊厂的 Q2S 子母路由器。除去比较强的组网能力，还算不错的信号质量，这个型号的设备在功能上可以说是垃圾中的战斗机：

- 不能配置路由。
- 无法对 DHCP 指定自身以外的网关和 DNS。
- 多点接入环境下无法使用 AP 模式（这在技术上可能有一些难度）。

换句话说，除了经常用的功能，其他路由器上应该有的高级设置砍掉了一大半。不过好在这些功能都可以在软件实现的一级网关中轻松完成，无线路由器作为二级网关，只要做好无线发射的本职工作就可以了。但我这里不得不吐槽的是，我的垃圾米11在覆盖区域交界的位置有着非常严重的反复横跳行为，导致碧蓝航线反复掉线，直到我反复优化设备摆放后才不太影响使用，而该问题在我之前的米10，爸妈的PX0，某果上都完全不影响使用，非常令我困惑。这也就回到了我之前的观点，有条件的话核心设备一定不要无线接入。

除去简单的组网配置，还算不错的信号质量，Q2S 的一个明显优势就在于支持电力组网。由于我家桥洞年份比较老，有线接入点比较有限，有一些被承重墙包围的区域就只能依靠电力组网来覆盖了。电力组网整体上性能有限，一般只能达到 20M 左右的带宽，但是相比起完全搜不到信号来说，对于手机看视频，听音乐的场景也可以称得上是质的飞跃了。

整体来看，目前的这套方案用到两个母路由，两个子路由，可以做到家中大部分区域 100M 以上接入。稍微令我不满的是子路由工作在电力线模式下工作有时并不稳定，但是对使用的影响有限。折腾这么久之后，我对于大部分人的建议也很简单：除非信号覆盖实在有问题，优先使用单体路由器，最好是加钱上顶级设备，这可以省去大量没必要的折腾。对于大多数人来说，多点接入的组网方式在体验上来说不会明显优于单体设备，也不会更省钱。我的建议临界点在 150 到 200 坪左右。即使需要多点接入，也尽量使用更少的 AP 数量。目前诸如 AP 面板这样的组网方式还在逐渐成熟的过程中，难免踩坑。而对于壕得不行的人来说，建议直接上企业级 AP，除去性价比比较低以外，接入质量还是比较有保障的。

## 服务器

家里用的服务器没有什么特别惊人的配置，整体属于性能略有溢出，任何一项在短时间内都不会成为瓶颈：

- CPU：i3 9100，对于 AIO 主机来说，相比起一众赛扬，构建虚拟集群时性能上会宽裕很多，而功耗和价格上的差距感知不明显。

- 内存：8G DDR4 * 2，看似很多，每台虚拟机分配 1G + ZFS 就差不多占满了。ZFS 坊间传闻 1T 数据要搭配 1G 内存，这里说的其实是 1T 的活动数据，实际使用中远大于这个比例的内存分配也不影响使用。

- HDD：西数红盘 8T * 2，网上对于西数红盘风评很差，但是出问题集中在 4T 盘上，8T 盘的质量还是可靠的，而且不是叠瓦。主要看重的是这个型号转速较低，噪音也许比企业盘稍小一些。即使有可靠性问题，两张盘组 raid Z1 也足够安全了。

- SSD：SN750 500G，分配给各台虚拟机做启动盘 + ZFS SLOG。SSD SLOG 在一般使用时感受不明显，但是对于随机读写/NFS 以及一些复杂使用场景有肉眼可见的提升。为了避免 SLOG 造成的 SSD 擦写磨损，划了比较大的区域。

- 电源：某厂 265W 铜牌，自己改了猫扇，几乎无声。

- 主板：华擎 Z390M-ITX/AC，自己带两个网口，做软路由正合适，扩展性也不错，就是有点贵。

这套配置整体待机功耗 50W 左右，一年下来也就是 200 块电费，对于社畜来说可以忽略不计。但是长期用下来可以改进的地方倒也很多：

- 应该加一块傲腾盘做 ZFS SLOG，相比起普通 SSD，性能更好，更耐磨损，算上磨损的话也要便宜得多。

- 由于是第一次折腾，为了减少翻车机会，没上 ECC 内存，也没上支持 ECC 内存的主板和 CPU。除去洋垃圾，使用全新零件还要支持 ECC 的话，成本还是要高上不少。

- 原本怕电源太吵，其实最吵的是 HDD 的炒豆子声，还是双份的。

- 目前使用的 SSD 在可靠性上确实已经不错了，但是考虑到 7*24 小时工作，可以考虑换企业级 SSD。虽然黑盘已经很贵了，企业级盘的单价还要再翻一倍左右。

- 考虑到网络设备的开销，目前网络中所有设备都是千兆规格，下一次更新可以考虑整体升级一下。目前来看 2.5G 网络就能跑满硬盘速度了。如果不是为了将来使用全盘 SSD 或者大规格 raid 做准备的话，万兆网络带来的实际提升就很有限了，而设备价格又要高出很多。

如你所见，这套东西虽然用起来还不错，但是整体思路是相当保守的，可以折腾的地方还很多。不过话说回来，我本来也不是什么硬核的 homdlab 玩家，家里没有双机热备的条件，折腾一下硬件就会导致全家断网+服务失效，影响很大，所以既然能用也就没有折腾的必要了。下一期我们会聊一些当前场景下更有折腾空间的东西，也就是设备上的软件服务，回见。
